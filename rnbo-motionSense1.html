<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RNBO • motionSense1</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f2f2f7;
        --panel: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: rgba(0, 0, 0, 0.08);
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Noto Sans",
          "Apple Color Emoji", "Segoe UI Emoji";
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #000000;
          --panel: #0b0b0f;
          --text: #f4f4f5;
          --muted: #a1a1aa;
          --border: rgba(255, 255, 255, 0.12);
        }
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: var(--sans);
        background: var(--bg);
        color: var(--text);
      }

      .wrap {
        max-width: 920px;
        margin: 0 auto;
        padding: 24px 16px 48px;
      }

      h1 {
        margin: 0;
        font-size: 28px;
        letter-spacing: -0.02em;
      }

      .sub {
        margin-top: 6px;
        color: var(--muted);
        line-height: 1.4;
        font-size: 14px;
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-top: 14px;
      }

      button {
        appearance: none;
        border: 1px solid var(--border);
        background: var(--panel);
        color: var(--text);
        border-radius: 12px;
        padding: 10px 12px;
        font-weight: 600;
        cursor: pointer;
      }
      button.primary {
        background: #2563eb;
        border-color: transparent;
        color: white;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .panel {
        margin-top: 16px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
      }

      .panel .hd {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .panel .hd .title {
        font-weight: 700;
      }
      .panel .hd .meta {
        color: var(--muted);
        font-size: 12px;
        font-family: var(--mono);
      }

      .panel .bd {
        padding: 12px 14px;
      }

      .kv {
        display: grid;
        grid-template-columns: 160px 1fr;
        gap: 8px 12px;
        font-size: 13px;
      }
      .kv .k {
        color: var(--muted);
      }
      .kv .v {
        font-family: var(--mono);
        font-size: 12px;
        word-break: break-word;
      }

      .paramList {
        margin-top: 12px;
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
      }

      .param {
        padding: 12px 12px;
        border-bottom: 1px solid var(--border);
      }
      .param:last-child {
        border-bottom: none;
      }
      .paramTop {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 10px;
        align-items: baseline;
        justify-content: space-between;
      }
      .paramName {
        font-weight: 700;
      }
      .paramId {
        color: var(--muted);
        font-family: var(--mono);
        font-size: 12px;
      }
      .paramMeta {
        color: var(--muted);
        font-size: 12px;
      }

      .paramControls {
        display: grid;
        grid-template-columns: 1fr 120px;
        gap: 10px;
        align-items: center;
        margin-top: 8px;
      }
      input[type="range"] {
        width: 100%;
      }
      .paramValue {
        font-family: var(--mono);
        font-size: 12px;
        text-align: right;
      }

      .log {
        margin-top: 12px;
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
      }
      .log pre {
        margin: 0;
        padding: 10px 12px;
        max-height: 240px;
        overflow: auto;
        font-family: var(--mono);
        font-size: 12px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .warn {
        color: #b45309;
      }
      @media (prefers-color-scheme: dark) {
        .warn {
          color: #fbbf24;
        }
      }
    </style>

    <!-- RNBO.js adapter library (docs/RNBO/RNBO.md)
         Pin to the export's RNBO version to avoid mismatches. This export is rnbo v1.3.3. -->
    <script src="https://js.cdn.cycling74.com/rnbo/1.3.3/rnbo.min.js"></script>

    <!-- Prevent favicon.ico 404 noise -->
    <link rel="icon" href="data:," />
  </head>

  <body>
    <div class="wrap">
      <h1>RNBO • motionSense1</h1>
      <div class="sub">
        Loads <code>motionSense1/motionSense1.export.json</code> into a WebAudio <code>AudioContext</code> and renders one
        slider per RNBO parameter using the exported ranges.
        <div class="warn" style="margin-top: 6px">
          Note: If opening this file directly (<code>file://</code>) blocks loading the export JSON, use the “Choose
          export.json…” button below, or serve this folder locally (any static file server works).
        </div>
      </div>

      <div class="row">
        <button id="startAudio" class="primary">Start Audio</button>
        <button id="stopAudio">Stop Audio</button>
        <button id="loadDefault">Load default export.json</button>
        <label style="display: inline-flex; align-items: center; gap: 8px">
          <span style="font-size: 13px; color: var(--muted)">Choose export.json…</span>
          <input id="filePick" type="file" accept=".json,application/json" />
        </label>
      </div>

      <div class="panel" style="margin-top: 16px">
        <div class="hd">
          <div class="title">Status</div>
          <div class="meta" id="secureContext">secureContext: —</div>
        </div>
        <div class="bd">
          <div class="kv">
            <div class="k">RNBO.js</div>
            <div class="v" id="rnboStatus">—</div>
            <div class="k">AudioContext</div>
            <div class="v" id="ctxStatus">—</div>
            <div class="k">Loaded patcher</div>
            <div class="v" id="patcherStatus">—</div>
            <div class="k">Device</div>
            <div class="v" id="deviceStatus">—</div>
          </div>
          <div class="log" aria-label="Log">
            <pre id="log"></pre>
          </div>
        </div>
      </div>

      <div class="panel" id="paramsPanel" style="display: none">
        <div class="hd">
          <div class="title">Parameters</div>
          <div class="meta" id="paramCount">—</div>
        </div>
        <div class="bd">
          <div class="paramList" id="paramList"></div>
        </div>
      </div>
    </div>

    <script>
      const els = {
        startAudio: document.getElementById("startAudio"),
        stopAudio: document.getElementById("stopAudio"),
        loadDefault: document.getElementById("loadDefault"),
        filePick: document.getElementById("filePick"),
        log: document.getElementById("log"),
        rnboStatus: document.getElementById("rnboStatus"),
        ctxStatus: document.getElementById("ctxStatus"),
        patcherStatus: document.getElementById("patcherStatus"),
        deviceStatus: document.getElementById("deviceStatus"),
        secureContext: document.getElementById("secureContext"),
        paramsPanel: document.getElementById("paramsPanel"),
        paramList: document.getElementById("paramList"),
        paramCount: document.getElementById("paramCount"),
      };

      els.secureContext.textContent = `secureContext: ${String(window.isSecureContext)}`;

      function log(msg) {
        const line = `[${new Date().toISOString()}] ${msg}`;
        els.log.textContent = `${line}\n${els.log.textContent}`.slice(0, 40_000);
      }

      function fmtNumber(n) {
        if (typeof n !== "number" || !Number.isFinite(n)) return String(n);
        const abs = Math.abs(n);
        if (abs === 0) return "0";
        if (abs >= 1000) return n.toFixed(0);
        if (abs >= 100) return n.toFixed(1);
        if (abs >= 10) return n.toFixed(2);
        return n.toFixed(4);
      }

      function deriveStep(min, max, steps) {
        if (typeof steps === "number" && steps > 1) return (max - min) / (steps - 1);
        const range = max - min;
        if (Number.isInteger(min) && Number.isInteger(max) && range <= 2048) return 1;
        if (range <= 1) return 0.001;
        if (range <= 10) return 0.01;
        if (range <= 100) return 0.1;
        return 1;
      }

      function setRnboStatus() {
        if (!window.RNBO) {
          els.rnboStatus.textContent = "RNBO not loaded (check network / CDN script tag)";
          return false;
        }
        els.rnboStatus.textContent = "RNBO loaded (global RNBO object available)";
        return true;
      }

      setRnboStatus();

      let audioContext = null;
      let device = null;
      let gainNode = null;
      let patcher = null;
      let audioParams = null;

      function updateCtxStatus() {
        if (!audioContext) {
          els.ctxStatus.textContent = "—";
          return;
        }
        els.ctxStatus.textContent = `state=${audioContext.state} sampleRate=${audioContext.sampleRate}`;
      }

      async function ensureAudioContext() {
        if (!audioContext) {
          const WAContext = window.AudioContext || window.webkitAudioContext;
          audioContext = new WAContext();
          gainNode = audioContext.createGain();
          gainNode.gain.value = 0.8;
          gainNode.connect(audioContext.destination);
          updateCtxStatus();
          log("Created AudioContext and output gain node.");
        }
        if (audioContext.state !== "running") {
          await audioContext.resume();
          updateCtxStatus();
          log("Resumed AudioContext.");
        }
      }

      async function stopAudio() {
        if (!audioContext) return;
        await audioContext.suspend();
        updateCtxStatus();
        log("Suspended AudioContext.");
      }

      async function loadPatcherFromUrl(url) {
        els.patcherStatus.textContent = `loading: ${url}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`fetch failed (${resp.status}) for ${url}`);
        return await resp.json();
      }

      async function loadPatcherFromAnyUrl(urls) {
        let lastErr = null;
        for (const url of urls) {
          try {
            // eslint-disable-next-line no-await-in-loop
            return await loadPatcherFromUrl(url);
          } catch (err) {
            lastErr = err;
          }
        }
        throw lastErr || new Error("Failed to load patcher");
      }

      async function loadPatcherFromFile(file) {
        els.patcherStatus.textContent = `loading from file: ${file.name}`;
        const text = await file.text();
        return JSON.parse(text);
      }

      function clearDevice() {
        if (device) {
          try {
            device.node.disconnect();
          } catch {
            // ignore
          }
        }
        device = null;
        audioParams = null;
        els.deviceStatus.textContent = "—";
        els.paramsPanel.style.display = "none";
        els.paramList.innerHTML = "";
      }

      async function createDeviceFromPatcher() {
        if (!window.RNBO) throw new Error("RNBO not loaded");
        if (!patcher) throw new Error("No patcher loaded");
        await ensureAudioContext();

        clearDevice();

        const { createDevice } = window.RNBO;
        device = await createDevice({ context: audioContext, patcher });
        device.node.connect(gainNode);
        audioParams = device?.node?.parameters || null;

        const rnboVersion = patcher?.desc?.meta?.rnboversion || "unknown";
        els.deviceStatus.textContent = `created • rnbo export version: ${rnboVersion}`;
        log(`Created RNBO device (export rnbo version: ${rnboVersion}).`);

        try {
          const rnboParamIds = device?.parametersById ? Array.from(device.parametersById.keys()) : [];
          const audioParamIds = audioParams ? Array.from(audioParams.keys()) : [];
          log(`RNBO parametersById: ${rnboParamIds.length} ids`);
          log(`AudioWorklet node.parameters: ${audioParamIds.length} ids`);
          if (audioParamIds.length) log(`AudioParam ids: ${audioParamIds.join(", ")}`);
        } catch {
          // ignore
        }

        renderParameters();
      }

      function findSignalAudioParam(p) {
        if (!audioParams) return null;
        const raw = String(p.paramId || "");
        const noLead = raw.replace(/^\//, "");
        const underscore = noLead.replace(/\//g, "_");
        const slug = noLead.replace(/[^A-Za-z0-9_]/g, "_");
        const name = String(p.name || "");

        const candidates = [
          raw,
          noLead,
          underscore,
          slug,
          `signal_${name}`,
          `signals_${name}`,
          name,
        ].filter(Boolean);

        const seen = new Set();
        for (const c of candidates) {
          if (seen.has(c)) continue;
          seen.add(c);
          const ap = audioParams.get(c);
          if (ap) return ap;
        }

        return null;
      }

      function renderParameters() {
        const list = els.paramList;
        list.innerHTML = "";

        const descParams = patcher?.desc?.parameters || [];
        els.paramCount.textContent = `${descParams.length} parameters`;
        els.paramsPanel.style.display = "";

        for (const p of descParams) {
          const paramId = p.paramId;
          const rnboParam = device?.parametersById?.get(paramId) || null;
          const signalAudioParam = p.type === "ParameterTypeSignal" ? findSignalAudioParam(p) : null;

          const wrapper = document.createElement("div");
          wrapper.className = "param";

          const top = document.createElement("div");
          top.className = "paramTop";

          const left = document.createElement("div");
          const name = document.createElement("div");
          name.className = "paramName";
          name.textContent = p.displayName || p.name || paramId;

          const idLine = document.createElement("div");
          idLine.className = "paramId";
          idLine.textContent = paramId;

          left.appendChild(name);
          left.appendChild(idLine);

          const meta = document.createElement("div");
          meta.className = "paramMeta";
          meta.textContent = `${p.type} • min=${p.minimum} max=${p.maximum} steps=${p.steps || 0}${
            p.exponent && p.exponent !== 1 ? ` exp=${p.exponent}` : ""
          }`;

          top.appendChild(left);
          top.appendChild(meta);

          const controls = document.createElement("div");
          controls.className = "paramControls";

          const slider = document.createElement("input");
          slider.type = "range";
          slider.min = String(p.minimum);
          slider.max = String(p.maximum);
          slider.step = String(deriveStep(p.minimum, p.maximum, p.steps));

          const value = document.createElement("div");
          value.className = "paramValue";
          value.textContent = "—";

          controls.appendChild(slider);
          controls.appendChild(value);

          wrapper.appendChild(top);
          wrapper.appendChild(controls);
          list.appendChild(wrapper);

          const setValueText = (v) => {
            value.textContent = `${fmtNumber(v)}${p.unit ? ` ${p.unit}` : ""}`;
          };

          // Initialize to exported initial value where possible.
          if (p.type === "ParameterTypeSignal") {
            if (!signalAudioParam) {
              slider.value = String(p.initialValue ?? p.minimum ?? 0);
              value.textContent = "Signal AudioParam not found";
            } else {
              try {
                signalAudioParam.value = p.initialValue;
              } catch {
                // ignore
              }
              slider.value = String(signalAudioParam.value);
              setValueText(signalAudioParam.value);
            }
          } else if (rnboParam) {
            try {
              rnboParam.value = p.initialValue;
            } catch {
              // ignore
            }
            slider.value = String(rnboParam.value);
            setValueText(rnboParam.value);

            // Keep the UI in sync with internal parameter changes.
            if (rnboParam.changeEvent && typeof rnboParam.changeEvent.subscribe === "function") {
              rnboParam.changeEvent.subscribe((v) => {
                slider.value = String(v);
                setValueText(v);
              });
            }
          } else {
            slider.value = String(p.initialValue ?? p.minimum ?? 0);
            value.textContent = "RNBO param not found";
          }

          slider.addEventListener("input", () => {
            const v = Number(slider.value);
            setValueText(v);

            if (p.type === "ParameterTypeSignal") {
              if (!signalAudioParam) return;
              try {
                signalAudioParam.value = v;
              } catch (err) {
                log(`Failed setting signal ${paramId}: ${err?.message || err}`);
              }
              return;
            }

            if (!rnboParam) return;
            try {
              rnboParam.value = v;
            } catch (err) {
              log(`Failed setting ${paramId}: ${err?.message || err}`);
            }
          });
        }
      }

      async function loadDefault() {
        try {
          patcher = await loadPatcherFromAnyUrl([
            // Works when serving the repo root as static files
            "./motionSense1/motionSense1.export.json",
            // Works when serving via Next/Vercel if the export is under /public/motionSense1/
            "/motionSense1/motionSense1.export.json",
          ]);
          els.patcherStatus.textContent = "loaded: motionSense1.export.json";
          log("Loaded patcher JSON (default path).");
          await createDeviceFromPatcher();
        } catch (err) {
          els.patcherStatus.textContent = `failed: ${err?.message || err}`;
          log(`Failed to load default export.json (${err?.message || err}). Try choosing the file manually.`);
        }
      }

      els.startAudio.addEventListener("click", async () => {
        try {
          if (!setRnboStatus()) return;
          await ensureAudioContext();
        } catch (err) {
          log(`Start Audio failed: ${err?.message || err}`);
        }
      });

      els.stopAudio.addEventListener("click", async () => {
        try {
          await stopAudio();
        } catch (err) {
          log(`Stop Audio failed: ${err?.message || err}`);
        }
      });

      els.loadDefault.addEventListener("click", async () => {
        try {
          await loadDefault();
        } catch (err) {
          log(`Load default failed: ${err?.message || err}`);
        }
      });

      els.filePick.addEventListener("change", async () => {
        const file = els.filePick.files && els.filePick.files[0];
        if (!file) return;
        try {
          patcher = await loadPatcherFromFile(file);
          els.patcherStatus.textContent = `loaded: ${file.name}`;
          log(`Loaded patcher JSON from file: ${file.name}`);
          await createDeviceFromPatcher();
        } catch (err) {
          els.patcherStatus.textContent = `failed: ${err?.message || err}`;
          log(`Failed to load patcher from file (${err?.message || err}).`);
        }
      });

      // Initial statuses
      updateCtxStatus();
      els.deviceStatus.textContent = "—";
      els.patcherStatus.textContent = "not loaded";
      log("Ready. Click “Start Audio”, then “Load default export.json”.");
    </script>
  </body>
</html>
